<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills & Recurring Payments - Personal Finance Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="flex-between" style="padding: 1rem 0;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-wallet" style="color: white; font-size: 1.5rem;"></i>
                    <h1 style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0;">Finance Tracker</h1>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
                    <a href="transactions.html" class="nav-link"><i class="fas fa-exchange-alt"></i> Transactions</a>
                    <a href="budget.html" class="nav-link"><i class="fas fa-chart-pie"></i> Budget</a>
                    <a href="savings.html" class="nav-link"><i class="fas fa-piggy-bank"></i> Savings</a>
                    <a href="bills.html" class="nav-link active"><i class="fas fa-file-invoice-dollar"></i> Bills</a>
                    <a href="networth.html" class="nav-link"><i class="fas fa-chart-line"></i> Net Worth</a>
                    <a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i> Reports</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header flex-between">
            <div>
                <h2 class="page-title">Bills & Recurring Payments</h2>
                <p class="page-subtitle">Track and manage your recurring bills</p>
            </div>
            <button onclick="showAddBillModal()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Bill
            </button>
        </div>

        <!-- Alerts for Overdue Bills -->
        <div id="overdueAlerts"></div>

        <!-- Summary Cards -->
        <div class="grid grid-4 mb-4">
            <div class="stat-card">
                <div class="stat-label">Total Bills</div>
                <div class="stat-value text-primary" id="totalBills">0</div>
                <div class="text-muted" style="font-size: 0.875rem;">Active bills</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-label">Monthly Total</div>
                <div class="stat-value text-danger" id="monthlyTotal">$0.00</div>
                <div class="text-muted" style="font-size: 0.875rem;">Per month</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">Due This Week</div>
                <div class="stat-value text-warning" id="dueThisWeek">0</div>
                <div class="text-muted" style="font-size: 0.875rem;">Bills</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Auto-Pay Bills</div>
                <div class="stat-value text-success" id="autoPayCount">0</div>
                <div class="text-muted" style="font-size: 0.875rem;">Automated</div>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="card mb-4">
            <div class="card-header">
                <span><i class="fas fa-calendar-alt"></i> Upcoming Bills</span>
            </div>
            <div id="upcomingBills">
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-calendar"></i></div>
                    <div class="empty-state-title">No upcoming bills</div>
                </div>
            </div>
        </div>

        <!-- All Bills List -->
        <div class="card mb-4">
            <div class="card-header">
                <span><i class="fas fa-list"></i> All Bills</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Bill Name</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Frequency</th>
                            <th>Auto-Pay</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billsTable">
                        <tr>
                            <td colspan="6" class="text-center text-muted" style="padding: 2rem;">
                                No bills found. Add your first bill to get started!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment History -->
        <div class="card mb-4" id="paymentHistorySection" style="display: none;">
            <div class="card-header">
                <span><i class="fas fa-history"></i> Payment History</span>
            </div>
            <div id="paymentHistory"></div>
        </div>
    </div>

    <!-- Add/Edit Bill Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Add Bill</span>
            </div>
            <form id="billForm" onsubmit="saveBill(event)">
                <div class="form-group">
                    <label class="form-label">Bill Name *</label>
                    <input type="text" id="billName" class="form-input" required placeholder="e.g., Electric, Internet, Netflix">
                </div>
                <div class="form-group">
                    <label class="form-label">Amount *</label>
                    <input type="number" id="billAmount" class="form-input" step="0.01" min="0" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date *</label>
                    <input type="date" id="billDueDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frequency *</label>
                    <select id="billFrequency" class="form-select" required>
                        <option value="Weekly">Weekly</option>
                        <option value="Bi-weekly">Bi-weekly</option>
                        <option value="Monthly" selected>Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="billAutoPay" style="margin-right: 0.5rem;">
                        Auto-pay enabled
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="billNotes" class="form-textarea" placeholder="Additional notes..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBillModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Bill
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mark Bill Paid Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="paymentModalTitle">Mark Bill as Paid</span>
            </div>
            <form id="paymentForm" onsubmit="savePayment(event)">
                <div class="form-group">
                    <label class="form-label">Payment Date *</label>
                    <input type="date" id="paymentDate" class="form-input" required>
                </div>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>Recording this payment will add it to your payment history.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Mark Paid
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let editingBillId = null;
        let payingBillId = null;

        function loadBillsPage() {
            updateSummaryCards();
            loadOverdueAlerts();
            loadUpcomingBills();
            loadBillsTable();
            loadPaymentHistory();
        }

        function updateSummaryCards() {
            const bills = getBills();

            const monthlyBills = bills.filter(b => b.frequency === 'Monthly');
            const weeklyBills = bills.filter(b => b.frequency === 'Weekly');
            const biweeklyBills = bills.filter(b => b.frequency === 'Bi-weekly');
            const quarterlyBills = bills.filter(b => b.frequency === 'Quarterly');
            const yearlyBills = bills.filter(b => b.frequency === 'Yearly');

            const monthlyTotal =
                monthlyBills.reduce((sum, b) => sum + parseFloat(b.amount), 0) +
                weeklyBills.reduce((sum, b) => sum + parseFloat(b.amount) * 4, 0) +
                biweeklyBills.reduce((sum, b) => sum + parseFloat(b.amount) * 2, 0) +
                quarterlyBills.reduce((sum, b) => sum + parseFloat(b.amount) / 3, 0) +
                yearlyBills.reduce((sum, b) => sum + parseFloat(b.amount) / 12, 0);

            const upcomingBills = getUpcomingBills(7);
            const autoPayBills = bills.filter(b => b.autoPay);

            document.getElementById('totalBills').textContent = bills.length;
            document.getElementById('monthlyTotal').textContent = formatCurrency(monthlyTotal);
            document.getElementById('dueThisWeek').textContent = upcomingBills.length;
            document.getElementById('autoPayCount').textContent = autoPayBills.length;
        }

        function loadOverdueAlerts() {
            const overdueBills = getOverdueBills();
            const container = document.getElementById('overdueAlerts');

            if (overdueBills.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="alert alert-danger mb-4">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Overdue Bills!</strong> You have ${overdueBills.length} overdue bill(s):
                        ${overdueBills.map(b => `${b.name} (${formatCurrency(b.amount)})`).join(', ')}
                    </div>
                </div>
            `;
        }

        function loadUpcomingBills() {
            const upcomingBills = getUpcomingBills(30);
            const container = document.getElementById('upcomingBills');

            if (upcomingBills.length === 0) {
                return; // Keep empty state
            }

            container.innerHTML = '';

            upcomingBills.forEach(bill => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = new Date(bill.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                let statusClass = 'badge-info';
                let statusText = `${daysUntil} day${daysUntil === 1 ? '' : 's'}`;

                if (daysUntil < 0) {
                    statusClass = 'badge-danger';
                    statusText = 'Overdue';
                } else if (daysUntil === 0) {
                    statusClass = 'badge-warning';
                    statusText = 'Due Today';
                } else if (daysUntil <= 3) {
                    statusClass = 'badge-warning';
                }

                const item = document.createElement('div');
                item.className = 'flex-between';
                item.style.padding = '1rem';
                item.style.borderBottom = '1px solid var(--border-color)';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">
                            ${bill.name}
                            ${bill.autoPay ? '<span class="badge badge-success" style="margin-left: 0.5rem;">Auto-pay</span>' : ''}
                        </div>
                        <div class="text-muted" style="font-size: 0.875rem;">
                            Due: ${formatDate(bill.dueDate)} â€¢ <span class="badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; font-size: 1.125rem; color: var(--danger-color); margin-bottom: 0.25rem;">
                            ${formatCurrency(bill.amount)}
                        </div>
                        <button class="btn btn-sm btn-success" onclick="showPaymentModal('${bill.id}')">
                            <i class="fas fa-check"></i> Mark Paid
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function loadBillsTable() {
            const bills = getBills();
            const tbody = document.getElementById('billsTable');

            if (bills.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" style="padding: 2rem;">No bills found</td></tr>';
                return;
            }

            // Sort by due date
            bills.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            tbody.innerHTML = bills.map(bill => `
                <tr>
                    <td style="font-weight: 600;">${bill.name}</td>
                    <td style="color: var(--danger-color); font-weight: 600;">${formatCurrency(bill.amount)}</td>
                    <td>${formatDate(bill.dueDate)}</td>
                    <td><span class="badge badge-secondary">${bill.frequency}</span></td>
                    <td>
                        ${bill.autoPay
                            ? '<span class="badge badge-success"><i class="fas fa-check"></i> Yes</span>'
                            : '<span class="badge badge-secondary"><i class="fas fa-times"></i> No</span>'}
                    </td>
                    <td>
                        <button class="btn-icon" onclick="showPaymentModal('${bill.id}')" title="Mark Paid">
                            <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        </button>
                        <button class="btn-icon" onclick="editBill('${bill.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="deleteBillConfirm('${bill.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function loadPaymentHistory() {
            const bills = getBills();
            const section = document.getElementById('paymentHistorySection');
            const container = document.getElementById('paymentHistory');

            const billsWithHistory = bills.filter(b => b.paymentHistory && b.paymentHistory.length > 0);

            if (billsWithHistory.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            billsWithHistory.forEach(bill => {
                const item = document.createElement('div');
                item.style.marginBottom = '1.5rem';
                item.innerHTML = `
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem;">${bill.name}</h4>
                    <div class="table-container">
                        <table style="font-size: 0.875rem;">
                            <thead>
                                <tr>
                                    <th>Payment Date</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bill.paymentHistory.slice().reverse().map(payment => `
                                    <tr>
                                        <td>${formatDate(payment.date)}</td>
                                        <td>${formatCurrency(payment.amount)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showAddBillModal() {
            editingBillId = null;
            document.getElementById('modalTitle').textContent = 'Add Bill';
            document.getElementById('billForm').reset();

            // Set default due date to first of next month
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            document.getElementById('billDueDate').valueAsDate = nextMonth;

            document.getElementById('billModal').classList.add('active');
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('active');
        }

        function saveBill(event) {
            event.preventDefault();

            const bill = {
                name: document.getElementById('billName').value,
                amount: parseFloat(document.getElementById('billAmount').value),
                dueDate: document.getElementById('billDueDate').value,
                frequency: document.getElementById('billFrequency').value,
                autoPay: document.getElementById('billAutoPay').checked,
                notes: document.getElementById('billNotes').value
            };

            if (editingBillId) {
                updateBill(editingBillId, bill);
            } else {
                addBill(bill);
            }

            closeBillModal();
            loadBillsPage();
        }

        function editBill(id) {
            const bills = getBills();
            const bill = bills.find(b => b.id === id);

            if (!bill) return;

            editingBillId = id;
            document.getElementById('modalTitle').textContent = 'Edit Bill';
            document.getElementById('billName').value = bill.name;
            document.getElementById('billAmount').value = bill.amount;
            document.getElementById('billDueDate').value = bill.dueDate;
            document.getElementById('billFrequency').value = bill.frequency;
            document.getElementById('billAutoPay').checked = bill.autoPay;
            document.getElementById('billNotes').value = bill.notes || '';

            document.getElementById('billModal').classList.add('active');
        }

        function deleteBillConfirm(id) {
            if (confirm('Are you sure you want to delete this bill?')) {
                deleteBill(id);
                loadBillsPage();
            }
        }

        function showPaymentModal(id) {
            payingBillId = id;
            const bills = getBills();
            const bill = bills.find(b => b.id === id);

            document.getElementById('paymentModalTitle').textContent = `Mark "${bill.name}" as Paid`;
            document.getElementById('paymentDate').valueAsDate = new Date();
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function savePayment(event) {
            event.preventDefault();

            const paymentDate = document.getElementById('paymentDate').value;
            markBillPaid(payingBillId, paymentDate);

            closePaymentModal();
            loadBillsPage();

            // Show success message
            const container = document.querySelector('.container');
            const message = document.createElement('div');
            message.className = 'alert alert-success';
            message.style.position = 'fixed';
            message.style.top = '2rem';
            message.style.right = '2rem';
            message.style.zIndex = '2000';
            message.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <div>Bill marked as paid!</div>
            `;
            document.body.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        // Close modals when clicking outside
        document.getElementById('billModal').addEventListener('click', function(e) {
            if (e.target === this) closeBillModal();
        });

        document.getElementById('paymentModal').addEventListener('click', function(e) {
            if (e.target === this) closePaymentModal();
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadBillsPage();
        });
    </script>
</body>
</html>
